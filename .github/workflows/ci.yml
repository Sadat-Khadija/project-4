name: Deploy
on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd ~/project-4
            git fetch origin main
            git reset --hard origin/main

            # Activate venv and install deps
            source ~/test-env/bin/activate
            python -m pip install -r requirements.txt

            # Load env and migrate
            cd backend
            export $(cat .env | xargs)
            python manage.py migrate

            # Restart app (tmux example)
            tmux kill-session -t app || true
            tmux new -d -s app "cd ~/project-4/backend && source ~/test-env/bin/activate && export \$(cat .env | xargs) && python manage.py runserver 0.0.0.0:8000 --insecure"
