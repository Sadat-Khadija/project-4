name: Deploy
on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd ~/project-4
            git fetch origin main
            git reset --hard origin/main

            # Activate venv and install deps
            source ~/test-env/bin/activate
            python -m pip install -r requirements.txt

            # Load env and migrate
            cd backend
            export $(cat .env | xargs)
            python manage.py migrate

            # Restart backend tmux session
            tmux kill-session -t backend || true
            tmux new -d -s backend "cd /home/ubuntu/project-4/backend && source /home/ubuntu/test-env/bin/activate && export \$(cat .env | xargs) && python manage.py runserver 0.0.0.0:8000 --insecure"

            # Restart frontend tmux session (dev server)
            tmux kill-session -t frontend || true
            tmux new -d -s frontend "cd /home/ubuntu/project-4/frontend && npm install && npm run dev -- --host 0.0.0.0 --port 5173"
